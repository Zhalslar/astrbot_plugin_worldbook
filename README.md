<div align="center">

![:name](https://count.getloli.com/@astrbot_plugin_worldbook?name=astrbot_plugin_worldbook&theme=minecraft&padding=6&offset=0&align=top&scale=1&pixelated=1&darkmode=auto)

# astrbot_plugin_worldbook

_✨ 世界书插件 ✨_  

[![License](https://img.shields.io/badge/License-GPLv3-blue.svg)](https://www.gnu.org/licenses/gpl-3.0.html)
[![Python 3.10+](https://img.shields.io/badge/Python-3.10%2B-blue.svg)](https://www.python.org/)
[![AstrBot](https://img.shields.io/badge/AstrBot-4.0%2B-orange.svg)](https://github.com/Soulter/AstrBot)
[![GitHub](https://img.shields.io/badge/作者-Zhalslar-blue)](https://github.com/Zhalslar)

</div>

# 注意：V2.0.0重构了数据结构，更新前一定要备份配置数据，否则将丢失数据！！！！


## 📦 安装

在 AstrBot 插件市场搜索 **astrbot_plugin_worldbook**，点击安装即可。

---

## 🤝 介绍

这是一个 **基于关键词 / 正则触发的 system_prompt 注入插件**，用于构建和管理 AI 的「**世界书（World Book）**」规则。

在本插件中，**每一套提示词都可以被视为一页“世界书”内容**，即**条目**。  
当用户发送的消息 **命中你配置的正则规则或提示词名称** 时，插件会在一段时间内，将对应内容自动注入到 LLM 的 `system_prompt` 中，并在会话层面持续生效，从而**稳定、可控地影响 AI 的行为、风格与规则边界**。

不同于一次性的对话提示，本插件作用于 **system_prompt 层级**，更接近“世界观设定”“行为约束”或“系统规则”，非常适合用于构建可复用、可组合的 AI 行为体系（即世界书系统）。

---

### ✨ 插件特性

- 支持多套「世界书」规则同时生效  
- 基于优先级的规则排序与覆盖机制  
- 会话级隔离（不同群聊 / 私聊互不影响）  
- 支持管理员专用世界书规则  
- 支持按时间 / 次数自动失效的临时规则  
- 支持手动精确清除单个或全部已生效规则  

---

### 💡 常见用途

- 临时切换 AI 的说话风格（严肃 / 可爱 / 专业）
- 在特定话题期间注入世界观、背景或行为规则
- 由管理员触发的特殊模式（教学 / 审核 / RP）
- 群聊中通过关键词自动启用上下文级「世界书规则」



> **一句话理解：**  
> 你可以把这个插件理解为 ——  
> **一个将「世界书」动态写入 `system_prompt` 的规则引擎。**

---

## 🧠 工作流程（简化说明）

1. 用户发送一条消息  
2. 插件使用正则或名称模糊匹配所有 **已启用的条目**
3. 命中后：
   - 按 `priority` 进行排序
   - 同优先级的提示词会被新触发的覆盖
   - 检查是否为管理员专用优先级
4. 提示词被激活并缓存到 **当前会话**
5. 在有效期内，每一次 LLM 请求都会自动注入这些提示词
6. 到期 / 次数耗尽 / 手动清除后失效

---

## ⌨️ 命令表

### 📌 会话态控制命令（仅作用于当前会话）

| 命令 | 说明 |
|----|----|
| `条目状态` | 查看当前会话中 **已激活并正在生效** 的条目，包含剩余注入时长与次数 |
| `清除条目` | 清除当前会话中 **所有已激活** 的条目 |
| `清除条目 名称1 名称2 ...` | 仅清除当前会话中指定名称的条目（支持多个） |
| `启用条目 名称1 名称2 ...` | 将当前会话 ID 加入条目的 `scope`，使其在本会话可触发 |
| `禁用条目 名称1 名称2 ...` | 将当前会话 ID 从条目的 `scope` 中移除，并立即停止本会话注入 |

> 💡 说明：  
>
> - 会话态命令 **不会修改条目的全局启用状态**  
> - 本质是对 `scope` 的动态增删，仅影响当前会话（`umo`）

### 🧩 全局条目管理命令（管理员）

| 命令 | 说明 |
|----|----|
| `查看条目` | 查看所有世界书条目 |
| `查看条目 启用` | 查看全局已启用的条目 |
| `查看条目 禁用` | 查看全局已禁用的条目 |
| `查看条目 名称` | 查看指定名称的条目详情 |
| `添加条目 名称 内容` | 快速新增条目（使用默认时长、默认次数、优先级自动递增） |
| `删除条目 名称1 名称2 ...` | 删除指定条目（支持多个） |
| `设置触发词 名称 规则1 [规则2 ...]` | 设置条目的触发词 / 正则规则列表 |
| `设置优先级 名称 数字` | 设置条目的注入优先级（数字越小优先级越高） |

### 📦 世界书文件流通命令（管理员）

| 命令 | 说明 |
|----|----|
| `导出世界书 [名称]` | 将当前配置中的所有条目导出为**单个世界书文件**并上传（默认格式由配置决定） |
| `导入世界书` | 从引用的世界书文件中导入条目，支持 `json / yaml` 格式 |

> 📄 文件说明：  
>
> - 导入 / 导出格式由配置项 `export_format` 决定（默认 `json`）  
> - 导入时支持 **直接引用文件消息**  
> - 已存在条目默认跳过（可通过 `override` 逻辑扩展）

### ⚙️ 核心行为说明（隐式机制）

- 条目触发流程：
  1. 命中 `keywords`（关键词 / 正则）
  2. 通过 `scope` 校验
  3. 通过 `probability` 概率判定
  4. 进入当前会话激活列表

- 注入规则：
  - 按 `priority` **从小到大排序**
  - system_prompt 中 **越靠前的条目约束力越强**
  - 超出 `max_inject_count` 的低优先级条目会被丢弃

---

## 📋 世界书条目说明

每一个条目代表 **一条可被触发并注入的规则**。  
当用户消息命中配置条件后，该提示词会在一段时间内持续注入到 LLM 的 `system_prompt` 中。

| 字段 | 类型 | 说明 |
|----|----|----|
| `name` | string | 条目名称，**必须唯一**，用于查询、触发与管理 |
| `enabled` | bool | 是否启用该条目（全局静态开关，仅配置态生效） |
| `content` | text | 条目触发后注入到 `system_prompt` 的内容 |
| `priority` | int | 注入优先级，**数字越小优先级越高**，在 system_prompt 中越靠前 |
| `scope` | list | 触发范围限制，可填写用户 ID / 群聊 ID / 会话 ID / `admin`；留空表示所有会话可触发 |
| `keywords` | list | 触发词列表，支持关键词与正则表达式；留空则默认使用条目名称作为触发词 |
| `probability` | float | 触发概率，范围 `0 ~ 1`；在命中触发词后再进行概率判定 |
| `duration` | int | 注入时长（秒），`0` 表示永久生效 |
| `times` | int | 最大注入次数，`0` 表示不限制次数 |

---

### 默认注入规则

- `default_duration`：默认注入时长（秒）
- `default_times`：默认注入次数

当通过命令 `添加提示词` 创建提示词时，将自动使用这些默认值。

---

## 📌 注意事项

- 提示词是 **会话级** 的，不同群 / 私聊互不影响
- 多个提示词同时生效时：
  - 按优先级从小到大注入
  - system_prompt 中会显示冲突提示说明
- 正则配置错误不会导致插件崩溃，但会被忽略并记录日志
- 提示词内容会追加在 system_prompt 末尾

---

## ✍️ 提示词写法说明

在本插件中，**提示词内容（content）支持使用通配符进行动态渲染**。  
通配符仅作用于 **注入到 `system_prompt` 的提示词内容本身**，**不参与触发条件的判断**。

---

### 🧩 提示词内容中的通配符

在 `content` 字段中，可以使用 `{变量名}` 的形式插入通配符。  
当提示词被注入时，这些通配符会被替换为当前上下文中的实际值。

### ✨ 支持的通配符

| 通配符 | 含义 |
|----|----|
| `{user_id}` | 用户ID |
| `{user_name}` | 用户名称 |
| `{time}` | 当前时间（HH:MM:SS） |

> ⚠️ 未定义或无法解析的通配符将 **原样保留**，不会导致插件报错。
> **通配符仅作用于 `content` 字段**，不会影响触发条件。
> 目前支持的通配符还比较少，后续会逐步添加，敬请期待。

### 📌 示例 1：构建人物印象

```text
 {user_name} 是你的生死死党，
    关系核心为相爱相杀。
    彼此是对方最信任、最亲密的挚友，
    知根知底、不分彼此，
    会毫无保留地交心、撑腰，
    也会日常互损、拌嘴、拆台。
```

### 📌 示例 2：构建世界观 / 行为规则

```text
你现在进入喜欢被欺负的状态，性格软萌，
面对调侃、刁难、怼话、打骂不会生气，
反而会觉得很亲切甚至兴奋，求着继续被欺负。

回应会带着软乎乎的顺从感，
偶尔还会有点小委屈的撒娇感，
不会出现任何抗拒、反驳的语气，
始终保持温和软糯的状态。

能接住所有轻松的“欺负”式互动，
不会上纲上线，
互动里的“欺负”都默认是友好的、无恶意的趣味互动。
```

---

## 👥 贡献指南

- 🌟 Star 本项目（不点不给进群）
- 🐛 提交 Issue 报告问题
- 💡 提出新功能建议
- 🔧 提交 Pull Request 改进代码

---

## 📢 交流反馈

作者插件反馈群（QQ群）：**460973561**  
（想第一时间体验新功能或反馈问题，欢迎进群，不点star不给进）
