<div align="center">

![:name](https://count.getloli.com/@astrbot_plugin_worldbook?name=astrbot_plugin_worldbook&theme=minecraft&padding=6&offset=0&align=top&scale=1&pixelated=1&darkmode=auto)

# astrbot_plugin_worldbook

_✨ 世界书插件 ✨_  

[![License](https://img.shields.io/badge/License-GPLv3-blue.svg)](https://www.gnu.org/licenses/gpl-3.0.html)
[![Python 3.10+](https://img.shields.io/badge/Python-3.10%2B-blue.svg)](https://www.python.org/)
[![AstrBot](https://img.shields.io/badge/AstrBot-4.0%2B-orange.svg)](https://github.com/Soulter/AstrBot)
[![GitHub](https://img.shields.io/badge/作者-Zhalslar-blue)](https://github.com/Zhalslar)

</div>

## 🤝 介绍

这是一个 **基于关键词 / 正则触发的 system_prompt 注入插件**，用于构建和管理 AI 的「**世界书（World Book）**」规则。

在本插件中，**每一套提示词都可以被视为一页“世界书”内容**。  
当用户发送的消息 **命中你配置的正则规则或提示词名称** 时，插件会在一段时间内，将对应内容自动注入到 LLM 的 `system_prompt` 中，并在会话层面持续生效，从而**稳定、可控地影响 AI 的行为、风格与规则边界**。

不同于一次性的对话提示，本插件作用于 **system_prompt 层级**，更接近“世界观设定”“行为约束”或“系统规则”，非常适合用于构建可复用、可组合的 AI 行为体系（即世界书系统）。

---

### ✨ 插件特性

- 支持多套「世界书」规则同时生效  
- 基于优先级的规则排序与覆盖机制  
- 会话级隔离（不同群聊 / 私聊互不影响）  
- 支持管理员专用世界书规则  
- 支持按时间 / 次数自动失效的临时规则  
- 支持手动精确清除单个或全部已生效规则  

---

### 💡 常见用途

- 临时切换 AI 的说话风格（严肃 / 可爱 / 专业）
- 在特定话题期间注入世界观、背景或行为规则
- 由管理员触发的特殊模式（教学 / 审核 / RP）
- 群聊中通过关键词自动启用上下文级「世界书规则」

---

> **一句话理解：**  
> 你可以把这个插件理解为 ——  
> **一个将「世界书」动态写入 `system_prompt` 的规则引擎。**


## 🧠 工作流程（简化说明）

1. 用户发送一条消息  
2. 插件使用正则或名称模糊匹配所有 **已启用的提示词模板**
3. 命中后：
   - 按 `priority` 进行排序
   - 同优先级的提示词会被新触发的覆盖
   - 检查是否为管理员专用优先级
4. 提示词被激活并缓存到 **当前会话**
5. 在有效期内，每一次 LLM 请求都会自动注入这些提示词
6. 到期 / 次数耗尽 / 手动清除后失效

---

## 📦 安装

在 AstrBot 插件市场搜索 **astrbot_plugin_worldbook**，点击安装即可。

---

## ⌨️ 命令表

### 📌 会话控制类命令

| 命令 | 说明 |
|----|----|
| `提示词状态` | 查看当前会话中 **正在生效** 的提示词列表、剩余时间与注入次数 |
| `清除提示词` | 清除当前会话中 **所有已激活** 的提示词 |
| `清除提示词 名称1 名称2 ...` | 仅清除指定名称的提示词（支持多个） |

---

### 🧩 提示词管理命令

| 命令 | 说明 |
|----|----|
| `查看提示词` | 查看所有提示词 |
| `查看提示词 启用` | 仅查看已启用的提示词 |
| `查看提示词 禁用` | 仅查看已禁用的提示词 |
| `查看提示词 名称` | 查看指定名称的提示词 |
| `添加提示词 名称 内容` | 快速添加一个提示词（使用默认时长、次数、优先级自增） |
| `删除提示词 名称1 名称2 ...` | 删除指定提示词（支持多个） |
| `启用提示词 名称1 名称2 ...` | 启用指定提示词 |
| `禁用提示词 名称1 名称2 ...` | 禁用指定提示词 |

---

## 🧩 提示词模板（prompt_templates）

每一套提示词模板代表 **一条可被触发并注入的规则**。  
当用户消息命中配置条件后，该提示词会在一段时间内持续注入到 LLM 的 `system_prompt` 中。

### 📋 模板字段说明

| 字段 | 类型 | 说明 |
|----|----|----|
| `name` | string | 提示词名称，**必须唯一** |
| `enable` | bool | 是否启用该提示词 |
| `content` | text | 注入到 `system_prompt` 的提示词内容 |
| `priority` | int | 触发优先级，**数字越小越先注入** |
| `regexs` | list | 触发用的正则表达式列表，不填则使用名称模糊匹配 |
| `duration` | int | 注入时长（秒），`0` 表示一直生效 |
| `times` | int | 最大注入次数，`0` 表示不限制 |

---

## ⚙️ 全局配置说明

### 管理员优先级（admin_priority_str）

- 配置为一组数字
- 处于这些优先级的提示词 **仅管理员可触发**
- 普通用户触发时会被自动忽略

---

### 默认注入规则

- `default_duration`：默认注入时长（秒）
- `default_times`：默认注入次数

当通过命令 `添加提示词` 创建提示词时，将自动使用这些默认值。

---

## 📌 注意事项

- 提示词是 **会话级** 的，不同群 / 私聊互不影响
- 多个提示词同时生效时：
  - 按优先级从小到大注入
  - system_prompt 中会显示冲突提示说明
- 正则配置错误不会导致插件崩溃，但会被忽略并记录日志
- 提示词内容会追加在 system_prompt 末尾

---

## 👥 贡献指南

- 🌟 Star 本项目（不点不给进群）
- 🐛 提交 Issue 报告问题
- 💡 提出新功能建议
- 🔧 提交 Pull Request 改进代码

---

## 📢 交流反馈

作者插件反馈群（QQ群）：**460973561**  
（想第一时间体验新功能或反馈问题，欢迎进群，不点star不给进）
