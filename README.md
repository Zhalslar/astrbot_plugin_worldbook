<div align="center">

![:name](https://count.getloli.com/@astrbot_plugin_worldbook?name=astrbot_plugin_worldbook&theme=minecraft&padding=6&offset=0&align=top&scale=1&pixelated=1&darkmode=auto)

# astrbot_plugin_worldbook

_✨ 世界书插件 ✨_  

[![License](https://img.shields.io/badge/License-GPLv3-blue.svg)](https://www.gnu.org/licenses/gpl-3.0.html)
[![Python 3.10+](https://img.shields.io/badge/Python-3.10%2B-blue.svg)](https://www.python.org/)
[![AstrBot](https://img.shields.io/badge/AstrBot-4.0%2B-orange.svg)](https://github.com/Soulter/AstrBot)
[![GitHub](https://img.shields.io/badge/作者-Zhalslar-blue)](https://github.com/Zhalslar)

</div>

# ⚠️ 重要提醒：升级到 V2.0.0 前务必备份数据，否则配置会丢失

---

## 📦 安装方法

在 AstrBot 插件市场搜索 **astrbot_plugin_worldbook**，点击安装即可。

---

## 🤝 这是干嘛用的？

这是一个**关键词触发的提示词管理工具**。

简单来说：你可以预设一堆"人设卡"或"规则卡"（我们叫**条目**），当聊天中出现特定关键词时，插件就会自动把这些规则塞进 AI 的"大脑"（system_prompt）里，让 AI 临时换个人格、换个语气，或者遵守特定规则。

**和普通的提示词有什么区别？**

- 普通提示词：说一次管一句
- 世界书：触发后持续生效一段时间，不用每次都提醒 AI

---

## ✨ 能做什么？

| 功能 | 说明 |
|------|------|
| 多个人设同时生效 | 比如既让 AI 变可爱，又让它记住某个世界观 |
| 优先级管理 | 重要的规则排在前面，会被优先遵守 |
| 群聊隔离 | A 群触发的规则不影响 B 群 |
| 管理员专属 | 可以设置只有管理员能触发的特殊模式 |
| 自动过期 | 可以设置规则在 N 秒后或 N 次对话后自动失效 |
| 手动清除 | 随时取消已生效的规则 |

---

## 💡 实际应用场景

- **临时换风格**：让 AI 突然变严肃、变萌、变专业
- **剧情模式**：跑团时自动注入世界观设定
- **管理员模式**：触发后 AI 进入"教学模式"或"审核模式"
- **群聊彩蛋**：特定关键词触发隐藏人格

> **一句话总结**：这是一个**让 AI 动态切换人设的规则引擎**。

---

## 🧠 怎么工作的？

1. 你发消息 → 插件检查是否命中某个规则
2. 命中了 → 把对应的人设卡塞进 AI 大脑
3. 接下来一段时间，AI 都会带着这个人设回复
4. 时间到了/次数用完了/你手动取消 → 恢复默认

---

## ⌨️ 命令大全

### 📌 只管当前聊天（普通用户也能用）

| 命令 | 干什么用的 |
|------|-----------|
| `条目状态` | 看看当前有哪些规则正在生效，还剩多久 |
| `清除条目` | 取消当前聊天的所有规则 |
| `清除条目 名称1 名称2` | 只取消指定的规则 |
| `启用条目 名称1 名称2` | 让某个规则在当前聊天可以触发 |
| `禁用条目 名称1 名称2` | 让某个规则在当前聊天不能触发 |

> 💡 这些命令**只影响当前聊天**，不会改全局设置

---

### 🧩 管理所有规则（需要管理员权限）

| 命令 | 干什么用的 |
|------|-----------|
| `查看条目` | 列出所有规则 |
| `查看条目 启用` | 只看已启用的 |
| `查看条目 禁用` | 只看已禁用的 |
| `查看条目 名称` | 看某个规则的详细信息 |
| `添加条目 名称 内容` | 快速新建一个规则 |
| `删除条目 名称1 名称2` | 删除规则 |
| `设置触发词 名称 规则1 规则2` | 设置触发这个规则的关键词（支持正则） |
| `设置优先级 名称 数字` | 设置优先级，数字越小越优先 |

---

### 📦 备份与分享规则（管理员）

| 命令 | 干什么用的 |
|------|-----------|
| `导出世界书` | 把所有规则打包成一个文件发给你 |
| `导出世界书 名称` | 只导出某个规则 |
| `导入世界书` | 从文件导入规则（支持 json/yaml） |

> 📄 导入时直接引用文件消息即可，重复的规则默认会跳过

---

### ⚙️ 规则生效的底层逻辑

1. **触发检查**：消息命中关键词 → 检查是否在适用范围内 → 抽概率判定
2. **注入排序**：按优先级数字从小到大排列，数字小的排在 system_prompt 前面（约束力更强）
3. **数量限制**：超过 `max_inject_count` 的低优先级规则会被丢弃

---

## 📋 一个规则（条目）包含什么？

| 设置项 | 必填？ | 说明 |
|--------|--------|------|
| `name`（名称） | ✅ | 规则的名字，不能重复，用来管理和触发 |
| `enabled`（开关） | ❌ | 是否启用，默认开启 |
| `content`（内容） | ✅ | 触发后要告诉 AI 的话（会塞进 system_prompt） |
| `priority`（优先级） | ❌ | 数字越小越优先，默认自动递增 |
| `scope`（适用范围） | ❌ | 限定哪些群/人能触发，留空=所有人 |
| `keywords`（触发词） | ❌ | 哪些词能触发这个规则，留空=用名称当触发词 |
| `probability`（概率） | ❌ | 触发概率 0~1，默认 1（100%触发） |
| `duration`（持续时间） | ❌ | 生效多少秒，0=永久 |
| `times`（生效次数） | ❌ | 最多生效多少次，0=不限 |

---

### 默认值设置

- `default_duration`：新建规则默认持续多久（秒）
- `default_times`：新建规则默认生效多少次

---

## ⚠️ 使用注意

- 规则是**按聊天窗口隔离的**，A 群和 B 群互不影响
- 多个规则同时生效时，优先级高的排在前面
- 正则写错了不会崩，但会跳过并记录日志
- 规则内容会加在 system_prompt 的**末尾**

---

## ✍️ 高级玩法：动态内容（通配符）

你可以在规则内容里加"变量"，注入时会自动替换成实际值：

| 变量 | 会变成 |
|------|--------|
| `{user_id}` | 用户的 ID |
| `{user_name}` | 用户的名字 |
| `{time}` | 当前时间（时:分:秒） |

> ⚠️ 写错了的变量会原样保留，不会报错。目前支持的变量还不多，后续会加。

### 📌 示例 1：构建人物印象

```text
 {user_name} 是你的生死死党，
    关系核心为相爱相杀。
    彼此是对方最信任、最亲密的挚友，
    知根知底、不分彼此，
    会毫无保留地交心、撑腰，
    也会日常互损、拌嘴、拆台。
```

### 📌 示例 2：构建世界观 / 行为规则

```text
你现在进入喜欢被欺负的状态，性格软萌，
面对调侃、刁难、怼话、打骂不会生气，
反而会觉得很亲切甚至兴奋，求着继续被欺负。

回应会带着软乎乎的顺从感，
偶尔还会有点小委屈的撒娇感，
不会出现任何抗拒、反驳的语气，
始终保持温和软糯的状态。

能接住所有轻松的“欺负”式互动，
不会上纲上线，
互动里的“欺负”都默认是友好的、无恶意的趣味互动。
```

---

## 👥 贡献指南

- 🌟 Star 本项目（不点不给进群）
- 🐛 提交 Issue 报告问题
- 💡 提出新功能建议
- 🔧 提交 Pull Request 改进代码

---

## 📢 交流反馈

作者插件反馈群（QQ群）：**460973561**  
（想第一时间体验新功能或反馈问题，欢迎进群，不点star不给进）
